---
layout: post
title: k8s 网络
date: 2024-01-09 19:28 +0800

categories: [k8s]
tags: [k8s, 学习笔记]

img_path: /assets/img/2024-05-10-k8s 网络.assets
---

## 网络通信
### pod内部
一个pod里面所有的容器共享一个网络命名空间(network namespace)。Pod内容器可以直接通过localhost互相访问；
### pod与pod之间
在 Kubernetes 中，每个 Pod 都被赋予一个独立的 IP 地址，这个 IP 地址是在 Pod 创建时由 Kubernetes 分配的，通常被称为 Pod IP（当 Kubelet 接收到创建 Pod 的请求时，它会调用 CNI 插件来为 Pod 分配 IP 地址）。这个 IP 地址用于在同一集群中的不同 Pod 之间进行直接通信，而不需要知道底层宿主机的 IP 地址。
> 假设你有两台物理机 A 和 B，它们的物理机器 IP 分别为 IP-A 和 IP-B。当你将它们作为两个 Pod 放到同一个 Kubernetes 集群中时，Kubernetes 会为每个 Pod 分配一个 Pod IP，而不是为整个物理机分配一个虚拟 IP。
> 所以，如果你有两个 Pod，分别在两台物理机 A 和 B 上运行，它们的 Pod IP 分别为 Pod-IP-A 和 Pod-IP-B。你可以使用这两个 Pod IP 直接进行通信，而不需要关心底层宿主机的 IP 地址。
> 在这种情况下，你不需要使用虚拟 IP（vip）来进行通信，而是可以使用各自的 Pod IP。 Pod 之间的通信是透明的，Kubernetes 负责在集群中维护这些 IP 地址的映射关系，使得 Pod 之间的通信更加简单和抽象。

	
在Flannel（一种CNI）中，所有的Pod IP被一整个Overlay Network管理。它在真实宿主机IP之上搭建了一套网络，所有的Pod（即使在不同的宿主机上）都像是处在一个网络之下可以相互访问。

![image.png](Flannel-pod.png)

下面的例子中，Flannel守护进程起到打包、路由转发的作用，将两个处在不同宿主机的pod之间的数据包发送到目标机器的pod上。
![image.png](Flannel-route.png)


## 参考资料

- [https://www.zhihu.com/tardis/zm/art/140711132?source_id=1003](https://www.zhihu.com/tardis/zm/art/140711132?source_id=1003)
